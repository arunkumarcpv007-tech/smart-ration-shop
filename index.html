<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPDS | Elite Digital Citizen Portal</title>
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#0ea5e9',
                        secondary: '#6366f1',
                        accent: '#f59e0b',
                        success: '#10b981',
                        danger: '#f43f5e',
                    },
                    backgroundImage: {
                        'fintech-gradient': 'linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #2e1065 100%)',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: background-color 0.5s ease;
        }

        .premium-bg {
            min-height: 100vh;
            background: radial-gradient(circle at 0% 0%, #f8fafc 0%, #f1f5f9 100%);
            transition: all 0.5s ease;
        }

        .dark .premium-bg {
            background: radial-gradient(circle at 0% 0%, #0f172a 0%, #020617 100%);
        }

        .neo-glass {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .neo-glass {
            background: rgba(15, 23, 42, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* 3D Card Animation */
        .card-3d-container { perspective: 1200px; height: 240px; width: 100%; }
        .card-3d-inner {
            position: relative; width: 100%; height: 100%;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d; cursor: pointer;
        }
        .card-3d-container:hover .card-3d-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; border-radius: 24px; overflow: hidden;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }
        .card-back { transform: rotateY(180deg); background: #1e293b; }

        .btn-glow {
            box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4);
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(14, 165, 233, 0); }
            100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }

        .shimmer-bg {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .pulse-open { animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .fraud-overlay {
            position: fixed; inset: 0; background: rgba(239, 63, 94, 0.15);
            z-index: 9999; pointer-events: none; animation: flash 0.5s infinite;
        }
        @keyframes flash { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(14, 165, 233, 0.2); border-radius: 10px; }
        
        @keyframes move-truck {
            0% { left: 25%; top: 50%; opacity: 0; transform: scale(1); }
            10% { opacity: 1; transform: scale(1.1); }
            90% { opacity: 1; transform: scale(1.1); }
            100% { left: 66%; top: 33%; opacity: 0; transform: scale(1); }
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50 dark:bg-slate-950 transition-colors duration-500 overflow-x-hidden">
    <div id="root" class="premium-bg"></div>

    <script>
        // --- DATA ---
        const COMMODITIES = [
            { id: 'c1', name: 'Rice (Samba)', price: 3, unit: 'kg' },
            { id: 'c2', name: 'Sugar', price: 10, unit: 'kg' },
            { id: 'c3', name: 'Wheat', price: 2, unit: 'kg' },
            { id: 'c4', name: 'Refined Oil', price: 25, unit: 'L' },
            { id: 'c5', name: 'Toor Dal', price: 30, unit: 'kg' },
        ];

        // --- STATE ---
        let state = {
            userRole: null, // 'admin', 'staff', 'public'
            language: 'en',
            isDarkMode: true,
            shopStatus: 'OPEN',
            tokens: 15,
            usersWhoBought: ['RC-998877'],
            stock: { rice: 1250, sugar: 450, wheat: 800 },
            announcement: 'Ration distribution for November is ongoing. Wear masks at the counter.',
            activeBill: null, // { cardNumber: '', items: [], total: 0, paid: false }
            notifications: [
                { id: 1, text: 'Stock replenished for Zone A.', time: '10:00 AM', read: false },
                { id: 2, text: 'System backup completed successfully.', time: '09:30 AM', read: true },
            ],
            deliveryRequests: [
                { id: 1, name: 'Sivakami M.', type: 'Senior Citizen', status: 'pending' },
                { id: 2, name: 'Ganesan R.', type: 'Physically Challenged', status: 'pending' }
            ],
            auditLog: [{ timestamp: new Date().toLocaleTimeString(), action: 'System Monitoring Started' }],
            isNotifPanelOpen: false,
            bookedToken: null
        };

        // --- I18N ---
        const t = {
            en: {
                title: 'Smart Ration Bharat',
                sub: 'Digitalizing essential commodity distribution for every household.',
                launch: 'Launch Portal',
                admin: 'District Admin',
                staff: 'Village Staff',
                public: 'Public User',
                admin_sub: 'Manage Stock Allocations',
                staff_sub: 'Shop Ops & Billing',
                public_sub: 'Book Tokens & Pay',
                exit: 'Terminal Exit',
                appearance: 'Appearance',
                status: 'Operational Control',
                queue: 'Live Citizen Queue',
                billing: 'Smart Billing Terminal',
                verify: 'Initiate Card Scan',
                requests: 'Priority Dispatch',
                quota: 'Monthly Quota',
                bulletins: 'Bulletins',
                pay: 'Secure Checkout'
            },
            ta: {
                title: 'ஸ்மார்ட் ரேஷன் பாரதம்',
                sub: 'அத்தியாவசிய பொருட்கள் விநியோகத்தை டிஜிட்டல் மயமாக்குதல்.',
                launch: 'தளத்தைத் தொடங்கு',
                admin: 'நிர்வாகி',
                staff: 'ஊழியர்',
                public: 'குடிமகன்',
                admin_sub: 'இருப்பு ஒதுக்கீடு',
                staff_sub: 'பில்லிங் மற்றும் செயல்பாடு',
                public_sub: 'டோக்கன்கள் மற்றும் கட்டணம்',
                exit: 'வெளியேறு',
                appearance: 'தோற்றம்',
                status: 'செயல்பாட்டு நிலை',
                queue: 'குடிமக்கள் வரிசை',
                billing: 'ஸ்மார்ட் பில்லிங்',
                verify: 'அட்டை ஸ்கேன்',
                requests: 'முன்னுரிமை விநியோகம்',
                quota: 'மாத ஒதுக்கீடு',
                bulletins: 'அறிவிப்புகள்',
                pay: 'கட்டணம் செலுத்து'
            }
        };

        // --- HELPERS ---
        function setRole(role) {
            if (role === 'staff' || role === 'admin') {
                Swal.fire({
                    title: 'Verification Required',
                    input: 'password',
                    inputPlaceholder: 'Enter PIN (1234)',
                    confirmButtonColor: '#0ea5e9'
                }).then(res => {
                    if (res.value === '1234') {
                        state.userRole = role;
                        render();
                    } else if (res.isConfirmed) {
                        Swal.fire('Error', 'Invalid Access PIN', 'error');
                    }
                });
            } else {
                state.userRole = role;
                render();
            }
        }

        function logout() {
            state.userRole = null;
            render();
        }

        function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            document.documentElement.classList.toggle('dark', state.isDarkMode);
            render();
        }

        function toggleLang() {
            state.language = state.language === 'en' ? 'ta' : 'en';
            render();
        }

        function toggleNotifs() {
            state.isNotifPanelOpen = !state.isNotifPanelOpen;
            render();
        }

        function toggleShop() {
            state.shopStatus = state.shopStatus === 'OPEN' ? 'CLOSED' : 'OPEN';
            render();
        }

        function addAudit(action) {
            state.auditLog.unshift({ timestamp: new Date().toLocaleTimeString(), action });
            if (state.auditLog.length > 5) state.auditLog.pop();
        }

        // --- COMPONENT: NAV ---
        function renderNav() {
            const lang = t[state.language];
            const unread = state.notifications.filter(n => !n.read).length;
            const iconClass = state.userRole === 'admin' ? 'fa-shield-halved' : state.userRole === 'staff' ? 'fa-shop' : 'fa-leaf';
            const colorClass = state.userRole === 'admin' ? 'bg-primary' : state.userRole === 'staff' ? 'bg-success' : 'bg-primary';

            return `
            <nav class="sticky top-0 z-[100] flex justify-between items-center mb-10 neo-glass rounded-[28px] px-10 py-5 border dark:border-white/5 shadow-2xl transition-all">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 ${colorClass} rounded-2xl flex items-center justify-center text-white text-xl shadow-lg">
                        <i class="fa-solid ${iconClass}"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-extrabold tracking-tight dark:text-white">${lang[state.userRole === 'public' ? 'citizen_hub' : state.userRole === 'admin' ? 'admin' : 'staff']}</h2>
                        <p class="text-[10px] uppercase font-bold text-slate-500 tracking-widest">ID: ${state.userRole.toUpperCase()}-041</p>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <button onclick="toggleLang()" class="text-[11px] font-bold px-4 py-2 bg-slate-200 dark:bg-white/10 rounded-xl hover:text-primary transition-all">
                        ${state.language === 'en' ? 'தமிழ்' : 'English'}
                    </button>
                    
                    ${state.userRole === 'admin' ? `
                    <div class="relative">
                        <button onclick="toggleNotifs()" class="w-10 h-10 rounded-xl bg-slate-200 dark:bg-white/10 flex items-center justify-center dark:text-slate-200 relative">
                            <i class="fa-solid fa-bell text-lg"></i>
                            ${unread > 0 ? `<span class="absolute -top-1 -right-1 w-5 h-5 bg-danger text-white text-[10px] font-black rounded-full flex items-center justify-center animate-bounce">${unread}</span>` : ''}
                        </button>
                        ${state.isNotifPanelOpen ? renderNotifDropdown() : ''}
                    </div>` : ''}

                    <div class="flex items-center gap-3 border-l dark:border-white/10 pl-4">
                        <span class="text-[10px] font-black uppercase text-slate-500 hidden sm:block">${lang.appearance}</span>
                        <div onclick="toggleTheme()" class="w-14 h-8 flex items-center rounded-full p-1 cursor-pointer transition-all ${state.isDarkMode ? (state.userRole === 'staff' ? 'bg-success' : 'bg-primary') : 'bg-slate-300'}">
                            <div class="bg-white w-6 h-6 rounded-full shadow-md transform transition-transform ${state.isDarkMode ? 'translate-x-6' : 'translate-x-0'} flex items-center justify-center">
                                <i class="fa-solid ${state.isDarkMode ? 'fa-moon text-primary' : 'fa-sun text-accent'} text-[10px]"></i>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="logout()" class="bg-danger/10 text-danger px-6 py-2.5 rounded-xl text-xs font-bold border border-danger/20 hover:bg-danger hover:text-white transition-all">${lang.exit}</button>
                </div>
            </nav>`;
        }

        function renderNotifDropdown() {
            return `
            <div class="absolute right-0 mt-4 w-96 neo-glass rounded-[32px] border dark:border-white/10 shadow-2xl overflow-hidden fade-in z-[200]">
                <div class="p-6 border-b dark:border-white/10 flex justify-between items-center bg-white/5">
                    <h3 class="text-xs font-black dark:text-white uppercase">Notifications</h3>
                    <button onclick="state.notifications.forEach(n=>n.read=true); render();" class="text-[10px] font-bold text-primary">Mark all read</button>
                </div>
                <div class="max-h-[300px] overflow-y-auto custom-scrollbar">
                    ${state.notifications.map(n => `
                        <div class="p-5 border-b dark:border-white/5 flex gap-4 ${n.read ? 'opacity-50' : 'bg-primary/5'}">
                            <div class="w-2 h-2 rounded-full mt-2 shrink-0 ${n.read ? 'bg-slate-400' : 'bg-primary pulse-open'}"></div>
                            <div class="flex-1">
                                <p class="text-xs font-semibold dark:text-slate-200">${n.text}</p>
                                <p class="text-[9px] font-bold text-slate-500 mt-2">${n.time}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }

        // --- VIEW: LOGIN ---
        function renderLogin() {
            const lang = t[state.language];
            return `
            <div class="flex flex-col items-center justify-center min-h-screen px-6 py-12 transition-all duration-700">
                <div class="fixed top-8 right-8 flex gap-3 items-center">
                    <button onclick="toggleLang()" class="neo-glass px-4 py-2 rounded-xl text-xs font-bold uppercase hover:bg-white/10 transition-all text-slate-700 dark:text-slate-200">
                        ${state.language === 'en' ? 'தமிழ்' : 'English'}
                    </button>
                    <button onclick="toggleTheme()" class="w-10 h-10 neo-glass rounded-xl flex items-center justify-center text-amber-500">
                        <i class="fa-solid ${state.isDarkMode ? 'fa-sun' : 'fa-moon'}"></i>
                    </button>
                </div>
                <div class="text-center mb-16 fade-in">
                    <div class="inline-block p-4 neo-glass rounded-3xl mb-6"><i class="fa-solid fa-leaf text-teal-500 text-5xl"></i></div>
                    <h1 class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-teal-500 via-slate-800 to-amber-500 dark:via-white tracking-tighter mb-4">${lang.title}</h1>
                    <p class="text-slate-500 dark:text-gray-400 text-lg max-w-xl mx-auto">${lang.sub}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full max-w-6xl">
                    ${renderLoginCard('admin', lang.admin, lang.admin_sub, 'fa-city', 'from-blue-500 to-indigo-600')}
                    ${renderLoginCard('staff', lang.staff, lang.staff_sub, 'fa-store', 'from-teal-400 to-emerald-600')}
                    ${renderLoginCard('public', lang.public, lang.public_sub, 'fa-users', 'from-amber-400 to-orange-600')}
                </div>
            </div>`;
        }

        function renderLoginCard(role, title, sub, icon, gradient) {
            return `
            <button onclick="setRole('${role}')" class="group relative neo-glass rounded-[40px] p-10 text-center hover:scale-105 transition-all duration-500 fade-in overflow-hidden shadow-sm">
                <div class="absolute -top-24 -right-24 w-48 h-48 bg-gradient-to-br ${gradient} opacity-10 blur-3xl"></div>
                <div class="w-20 h-20 mx-auto bg-gradient-to-br ${gradient} rounded-3xl flex items-center justify-center text-white text-3xl mb-8 shadow-xl"><i class="fa-solid ${icon}"></i></div>
                <h3 class="text-2xl font-bold dark:text-white mb-2">${title}</h3>
                <p class="text-slate-500 text-sm mb-8">${sub}</p>
                <div class="flex items-center justify-center gap-2 text-primary font-bold text-sm uppercase tracking-widest transition-all group-hover:gap-4">${t[state.language].launch} <i class="fa-solid fa-chevron-right text-xs"></i></div>
            </button>`;
        }

        // --- VIEW: ADMIN ---
        function renderAdmin() {
            const lang = t[state.language];
            return `
            <div class="max-w-[1440px] mx-auto px-8 py-10 fade-in min-h-screen">
                ${renderNav()}
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="col-span-1 md:col-span-3 neo-glass rounded-[40px] p-10 border dark:border-white/10 min-h-[450px] flex flex-col">
                        <h3 class="text-2xl font-black dark:text-white mb-8 flex items-center gap-3"><i class="fa-solid fa-chart-area text-primary"></i> Inventory Overview</h3>
                        <div class="flex-1 relative"><canvas id="adminStockChart"></canvas></div>
                    </div>
                    <div class="col-span-1 neo-glass rounded-[40px] p-8 border dark:border-white/10 flex flex-col justify-between">
                        <h3 class="text-xs font-black uppercase text-slate-500 mb-6">System Health</h3>
                        <div class="space-y-6">
                            ${renderTile('Secure Hub', 'ENCRYPTED', 'fa-lock', 'success')}
                            ${renderTile('Fraud Watch', 'ACTIVE', 'fa-fingerprint', 'primary')}
                            ${renderTile('Uptime', '99.99%', 'fa-server', 'slate')}
                        </div>
                    </div>
                    <div class="col-span-2 neo-glass rounded-[40px] p-10 border dark:border-white/10">
                        <h3 class="text-2xl font-black dark:text-white mb-8 flex items-center gap-3"><i class="fa-solid fa-truck-ramp-box text-primary"></i> Stock Injection</h3>
                        <form onsubmit="handleDispatch(event)" class="space-y-6">
                            <select id="vSelect" class="w-full bg-white dark:bg-white/5 border dark:border-white/10 rounded-2xl px-5 py-4 dark:text-white font-bold outline-none">
                                <option>Mylapore Distribution Hub</option><option>Anna Nagar Hub</option><option>Tambaram Hub</option>
                            </select>
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" id="rAmt" placeholder="Rice (kg)" class="w-full bg-white dark:bg-white/5 border dark:border-white/10 rounded-2xl p-4 dark:text-white outline-none">
                                <input type="number" id="sAmt" placeholder="Sugar (kg)" class="w-full bg-white dark:bg-white/5 border dark:border-white/10 rounded-2xl p-4 dark:text-white outline-none">
                            </div>
                            <button class="w-full py-5 rounded-[24px] text-white font-black text-lg bg-gradient-to-r from-primary to-secondary btn-glow uppercase">Authorize Dispatch</button>
                        </form>
                    </div>
                    <div class="col-span-2 neo-glass rounded-[40px] p-10 border dark:border-white/10 overflow-hidden relative">
                        <h3 class="text-2xl font-black dark:text-white mb-6 flex items-center gap-3"><i class="fa-solid fa-map-location-dot text-accent"></i> Logistics Map</h3>
                        <div class="h-full min-h-[250px] bg-slate-900/50 rounded-3xl relative overflow-hidden">
                            <div class="absolute inset-0 opacity-10 bg-[radial-gradient(#fff_1px,transparent_1px)] [background-size:20px_20px]"></div>
                            <div class="absolute top-1/2 left-1/4 animate-[move-truck_10s_linear_infinite]"><i class="fa-solid fa-truck text-white text-lg drop-shadow-lg"></i></div>
                            <div class="absolute top-1/2 left-1/4 w-4 h-4 bg-primary rounded-full pulse-open"></div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderTile(label, val, icon, color) {
            return `<div class="p-5 bg-${color}/5 border border-${color}/10 rounded-3xl flex justify-between items-center"><div class="space-y-1"><p class="text-[10px] font-bold text-slate-500 uppercase">${label}</p><span class="text-lg font-black dark:text-white">${val}</span></div><i class="fa-solid ${icon} text-${color}"></i></div>`;
        }

        // --- VIEW: STAFF ---
        function renderStaff() {
            const lang = t[state.language];
            return `
            <div class="max-w-[1440px] mx-auto px-8 py-10 fade-in min-h-screen">
                ${renderNav()}
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="col-span-2 neo-glass rounded-[40px] p-10 border dark:border-white/10 flex items-center justify-between">
                        <div><h3 class="text-2xl font-black dark:text-white mb-2">${lang.status}</h3><p class="text-slate-500 text-sm">Citizen Portal Visibility</p></div>
                        <button onclick="toggleShop()" class="w-56 h-24 rounded-[32px] p-2 bg-slate-200 dark:bg-white/5 relative overflow-hidden">
                            <div class="absolute top-2 bottom-2 w-[calc(50%-4px)] rounded-[24px] transition-all duration-500 flex items-center justify-center font-black text-xs uppercase ${state.shopStatus === 'OPEN' ? 'left-[calc(50%+2px)] bg-success' : 'left-2 bg-danger'} text-white shadow-xl">${state.shopStatus}</div>
                        </button>
                    </div>
                    <div class="col-span-2 neo-glass rounded-[40px] p-10 border dark:border-white/10 flex items-center gap-10">
                        <div class="relative"><div class="absolute -inset-4 bg-primary/20 rounded-full blur-xl pulse-open"></div><div class="relative w-20 h-20 bg-primary/10 border border-primary/20 rounded-full flex items-center justify-center"><i class="fa-solid fa-users-viewfinder text-primary text-3xl"></i></div></div>
                        <div><p class="text-xs font-black uppercase text-slate-500 mb-1">${lang.queue}</p><h4 class="text-4xl font-black dark:text-white">${state.tokens + 4} People</h4></div>
                    </div>
                    <div class="col-span-2 neo-glass rounded-[40px] p-10 border dark:border-white/10 min-h-[650px] flex flex-col">
                        <h3 class="text-2xl font-black dark:text-white mb-8 flex items-center gap-3"><i class="fa-solid fa-barcode text-primary"></i> ${lang.billing}</h3>
                        ${!state.activeBill ? `
                            <form onsubmit="initBilling(event)" class="flex-1 flex flex-col justify-center space-y-6">
                                <input id="cInput" type="text" placeholder="ENTER CARD NO" class="w-full bg-slate-100 dark:bg-white/5 border dark:border-white/10 rounded-3xl px-10 py-8 text-3xl font-mono font-black text-primary outline-none text-center tracking-widest uppercase">
                                <button class="w-full py-6 rounded-[28px] text-white font-black text-xl bg-primary shadow-2xl hover:scale-105 active:scale-95 transition-all uppercase tracking-widest">${lang.verify}</button>
                            </form>` : renderBillingTerminal()}
                    </div>
                    <div class="col-span-2 neo-glass rounded-[40px] p-10 border dark:border-white/10 min-h-[650px] flex flex-col">
                        <h3 class="text-2xl font-black dark:text-white mb-8 flex items-center gap-3"><i class="fa-solid fa-truck-fast text-accent"></i> ${lang.requests}</h3>
                        <div class="flex-1 space-y-4 overflow-y-auto custom-scrollbar pr-2">
                            ${state.deliveryRequests.map(r => `
                                <div class="p-6 bg-slate-100 dark:bg-white/5 rounded-[32px] border dark:border-white/10 flex justify-between items-center group">
                                    <div><p class="font-black text-lg dark:text-white">${r.name}</p><span class="text-[10px] font-bold text-primary uppercase bg-primary/10 px-2 py-0.5 rounded-md">${r.type}</span></div>
                                    <div class="flex gap-2">
                                        ${r.status === 'pending' ? `<button onclick="handleReq(${r.id}, 'approved')" class="bg-success text-white px-5 py-2.5 rounded-xl text-[10px] font-black hover:scale-105 active:scale-95 transition-all">APPROVE</button><button onclick="handleReq(${r.id}, 'rejected')" class="bg-danger/10 text-danger border border-danger/20 px-5 py-2.5 rounded-xl text-[10px] font-black">REJECT</button>` : `<span class="text-[10px] font-black uppercase px-4 py-1.5 rounded-full border ${r.status === 'approved' ? 'bg-success/20 text-success border-success/20' : 'bg-danger/20 text-danger border-danger/20'}">${r.status}</span>`}
                                    </div>
                                </div>`).join('')}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderBillingTerminal() {
            const currentTotal = state.activeBill.items.reduce((sum, i) => sum + (i.quantity * i.pricePerUnit), 0);
            return `
            <div class="flex-1 flex flex-col">
                <div class="flex justify-between items-start mb-6">
                    <div><p class="text-[10px] text-slate-500 uppercase font-black">Draft Payload</p><p class="text-3xl font-mono font-black text-primary">#${state.activeBill.cardNumber}</p></div>
                    <button onclick="state.activeBill=null; render();" class="text-xs text-danger font-black uppercase underline">Discard</button>
                </div>
                <div class="flex-1 bg-slate-100 dark:bg-slate-900/50 rounded-[32px] p-6 border dark:border-white/10 flex flex-col">
                    <div class="flex-1 overflow-y-auto space-y-3 mb-6 pr-2 custom-scrollbar">
                        ${state.activeBill.items.length > 0 ? state.activeBill.items.map(item => `
                            <div class="flex justify-between items-center bg-white dark:bg-white/5 p-4 rounded-2xl border dark:border-white/5 shadow-sm group">
                                <div><p class="text-sm font-black dark:text-white">${item.name}</p><p class="text-[10px] font-bold text-slate-500">${item.quantity}${item.unit} @ ₹${item.pricePerUnit}/${item.unit}</p></div>
                                <div class="flex items-center gap-4"><span class="text-sm font-black text-primary">₹${item.quantity * item.pricePerUnit}</span><button onclick="removeBillItem('${item.id}')" class="text-slate-400 hover:text-danger p-2"><i class="fa-solid fa-trash-can"></i></button></div>
                            </div>`).join('') : '<div class="h-full flex items-center justify-center opacity-30 text-xs font-bold uppercase">No Items</div>'}
                    </div>
                    <div class="grid grid-cols-12 gap-3 pt-4 border-t dark:border-white/10">
                        <div class="col-span-6"><select id="commSelect" class="w-full bg-white dark:bg-white/5 border dark:border-white/10 p-3 rounded-xl text-xs font-bold dark:text-white outline-none">${COMMODITIES.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}</select></div>
                        <div class="col-span-3"><input id="commQty" type="number" value="1" min="1" class="w-full bg-white dark:bg-white/5 border dark:border-white/10 p-3 rounded-xl text-xs font-black dark:text-white text-center outline-none"></div>
                        <div class="col-span-3"><button onclick="addBillItem()" class="w-full h-full bg-primary text-white rounded-xl"><i class="fa-solid fa-plus"></i></button></div>
                    </div>
                </div>
                <div class="mt-8 flex justify-between items-end border-t dark:border-white/10 pt-6">
                    <div><p class="text-[10px] text-slate-500 uppercase font-black">Total Valuation</p><p class="text-4xl font-mono font-black text-primary">₹${currentTotal}.00</p></div>
                    <button onclick="commitBill()" class="bg-primary text-white px-8 py-5 rounded-2xl font-black text-sm hover:scale-105 active:scale-95 transition-all shadow-xl uppercase tracking-widest">Commit & Publish</button>
                </div>
            </div>`;
        }

        // --- VIEW: PUBLIC ---
        function renderPublic() {
            const lang = t[state.language];
            const tokenText = state.bookedToken ? `Slot Confirmed (#${state.bookedToken})` : lang.btn_token;
            return `
            <div class="max-w-[1440px] mx-auto px-8 py-10 fade-in min-h-screen">
                ${renderNav()}
                <div class="grid grid-cols-12 gap-8">
                    <section class="col-span-12 lg:col-span-8 space-y-8">
                        <div class="relative overflow-hidden rounded-[40px] p-12 text-white shadow-2xl min-h-[360px] flex flex-col justify-center ${state.shopStatus === 'OPEN' ? 'bg-fintech-gradient' : 'bg-slate-900 border-2 border-danger/20'}">
                            <div class="relative z-10">
                                <div class="flex items-center gap-4 mb-8">
                                    <div class="relative"><div class="absolute -inset-1 rounded-full blur-sm ${state.shopStatus === 'OPEN' ? 'bg-success/50 pulse-open' : 'bg-danger/50'}"></div><span class="relative flex h-4 w-4 rounded-full border-2 border-white ${state.shopStatus === 'OPEN' ? 'bg-success' : 'bg-danger'}"></span></div>
                                    <span class="text-sm font-bold uppercase tracking-[0.3em] text-slate-300">Hub Status: <span class="${state.shopStatus === 'OPEN' ? 'text-success' : 'text-danger'}">${state.shopStatus}</span></span>
                                </div>
                                <h1 class="text-5xl font-black mb-4 tracking-tighter">${state.shopStatus === 'OPEN' ? 'Priority Access Enabled.' : 'Distribution Halted.'}</h1>
                                <p class="text-lg text-slate-400 mb-10 max-w-xl">${state.shopStatus === 'OPEN' ? 'Shop is OPEN. Active stocks are ready for distribution.' : 'Shop is currently CLOSED. Next opening: Tomorrow 9:00 AM'}</p>
                                <button onclick="bookToken()" ${state.bookedToken || state.shopStatus === 'CLOSED' ? 'disabled' : ''} class="px-12 py-5 rounded-[24px] font-black text-lg bg-primary text-white hover:scale-105 active:scale-95 transition-all btn-glow uppercase disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed">
                                    ${tokenText}
                                </button>
                            </div>
                            <i class="fa-solid ${state.shopStatus === 'OPEN' ? 'fa-bolt-lightning' : 'fa-hourglass-half'} absolute right-[-40px] bottom-[-40px] text-[320px] text-white/5 pointer-events-none rotate-12"></i>
                        </div>
                    </section>
                    <aside class="col-span-12 lg:col-span-4 space-y-8">
                        <div class="card-3d-container"><div class="card-3d-inner">
                            <div class="card-front bg-gradient-to-br from-secondary to-primary p-8 text-white flex flex-col justify-between border border-white/20 shadow-xl overflow-hidden relative">
                                <div class="flex justify-between items-start z-10"><div><p class="text-[10px] font-bold tracking-[0.3em] opacity-70 uppercase">Smart Bharat ID</p><p class="text-lg font-black tracking-widest">ELITE TIER</p></div><i class="fa-solid fa-microchip text-4xl opacity-80"></i></div>
                                <div class="z-10"><p class="text-2xl font-bold tracking-widest uppercase mb-1">Raghavan K.</p><div class="flex gap-1"><span class="w-1.5 h-1.5 rounded-full bg-accent animate-pulse"></span><span class="w-1.5 h-1.5 rounded-full bg-white opacity-20"></span></div></div>
                                <div class="flex justify-between items-end z-10"><p class="font-mono text-sm opacity-60">RC-112233-TN-041</p><i class="fa-solid fa-wifi rotate-90 opacity-40"></i></div>
                                <div class="shimmer-bg absolute inset-0 pointer-events-none"></div>
                            </div>
                            <div class="card-back p-8 text-white flex flex-col items-center justify-center border border-white/10 shadow-xl relative overflow-hidden">
                                <p class="text-[10px] font-bold text-slate-400 mb-6 uppercase tracking-[0.2em] relative z-10">Secure Scannable UID</p>
                                <div class="bg-white p-3 rounded-2xl relative z-10"><img src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=RC-112233" class="w-24 h-24"></div>
                                <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-md -z-10"></div>
                            </div>
                        </div></div>
                        <div onclick="quickAction('Support')" class="neo-glass rounded-[32px] p-6 border dark:border-white/5 flex items-center justify-between group cursor-pointer shadow-lg hover:border-primary/50 transition-all">
                            <div class="flex items-center gap-4"><div class="w-10 h-10 rounded-xl bg-primary/10 text-primary flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-all"><i class="fa-solid fa-headset"></i></div><span class="text-sm font-black dark:text-white tracking-tight">Priority Support Concierge</span></div>
                            <i class="fa-solid fa-chevron-right text-slate-400 group-hover:text-primary transition-all group-hover:translate-x-1"></i>
                        </div>
                    </aside>
                    <section class="col-span-12 lg:col-span-4 h-full">
                        <div class="neo-glass rounded-[40px] p-8 border dark:border-white/10 h-full shadow-2xl">
                            <h3 class="text-xl font-extrabold dark:text-white mb-8 flex items-center gap-3"><i class="fa-solid fa-chart-line text-primary"></i> ${lang.quota}</h3>
                            <div class="space-y-8">${renderQuota('Rice (Samba)', 16, 20, 'primary')}${renderQuota('Sugar', 1, 3, 'accent')}${renderQuota('Wheat Flour', 5, 5, 'success')}</div>
                        </div>
                    </section>
                    <section class="col-span-12 lg:col-span-4 h-full">
                        <div class="neo-glass rounded-[40px] p-8 border dark:border-white/10 h-full flex flex-col shadow-2xl">
                            <h3 class="text-xl font-extrabold dark:text-white mb-8 flex items-center gap-3"><i class="fa-solid fa-receipt text-secondary"></i> Bill Status</h3>
                            ${state.activeBill ? `
                                <div class="bg-white/5 rounded-[32px] p-6 border border-white/5 flex-1 flex flex-col justify-between shadow-inner relative overflow-hidden group">
                                    <div class="flex justify-between items-center mb-6 relative z-10"><span class="px-4 py-1.5 rounded-full text-[10px] font-black tracking-widest ${state.activeBill.paid ? 'bg-success/20 text-success' : 'bg-accent/20 text-accent'}">${state.activeBill.paid ? 'VERIFIED' : 'ACTION DUE'}</span><span class="font-mono text-[10px] text-slate-500">#${state.activeBill.cardNumber}</span></div>
                                    <div class="mb-8 relative z-10"><p class="text-[10px] text-slate-500 uppercase font-black mb-1">Payload</p><p class="text-lg font-bold dark:text-white">${state.activeBill.items.map(i=>i.name).join(', ')}</p></div>
                                    <div class="flex justify-between items-end mb-10 relative z-10"><p class="text-[10px] text-slate-500 uppercase font-black">Valuation</p><p class="text-5xl font-black text-primary transition-all">₹${state.activeBill.items.reduce((sum,i)=>sum+(i.quantity*i.pricePerUnit), 0)}.00</p></div>
                                    ${!state.activeBill.paid ? `<button onclick="handlePay()" class="bg-primary text-white font-black py-5 rounded-2xl shadow-xl hover:brightness-110 active:scale-95 transition-all flex items-center justify-center gap-3"><i class="fa-solid fa-lock-shield"></i> Pay Now</button>` : ''}
                                    <i class="fa-solid fa-shield-halved absolute right-[-20px] bottom-[-20px] text-[180px] text-white/5 pointer-events-none group-hover:scale-110 transition-transform"></i>
                                </div>` : `<div class="flex-1 flex flex-col items-center justify-center opacity-30 p-12 text-center"><i class="fa-solid fa-bag-shopping text-4xl mb-6"></i><p class="text-xs font-black uppercase">No Active Transaction</p></div>`}
                        </div>
                    </section>
                    <section class="col-span-12 lg:col-span-4 h-full flex flex-col gap-8">
                        <div class="neo-glass rounded-[40px] p-8 border dark:border-white/10 flex-1 shadow-2xl">
                            <h3 class="text-xl font-extrabold dark:text-white mb-6 flex items-center gap-3"><i class="fa-solid fa-bullhorn text-accent"></i> ${lang.bulletins}</h3>
                            <div class="p-5 bg-primary/5 rounded-2xl border border-primary/10 group hover:bg-primary/10 transition-all cursor-pointer"><div class="flex gap-4"><div class="w-2 h-2 rounded-full bg-success mt-1.5 animate-pulse shrink-0"></div><p class="text-xs font-black dark:text-slate-200 leading-relaxed tracking-tight">"${state.announcement}"</p></div></div>
                        </div>
                    </section>
                </div>
            </div>`;
        }

        function renderQuota(name, taken, total, color) {
            return `
            <div class="space-y-3">
                <div class="flex justify-between items-end"><span class="text-xs font-black dark:text-slate-300 tracking-tight">${name}</span><span class="text-sm font-black dark:text-white">${taken} / ${total} <span class="text-[10px] font-bold text-slate-500 uppercase tracking-tighter">KG</span></span></div>
                <div class="h-2 w-full bg-slate-200 dark:bg-white/5 rounded-full overflow-hidden"><div class="h-full bg-${color} shadow-[0_0_10px_rgba(0,0,0,0.2)] transition-all duration-1000" style="width: ${(taken/total)*100}%"></div></div>
            </div>`;
        }

        // --- HANDLERS ---
        function render() {
            const root = document.getElementById('root');
            if (!state.userRole) {
                root.innerHTML = renderLogin();
            } else if (state.userRole === 'admin') {
                root.innerHTML = renderAdmin();
                initChart();
            } else if (state.userRole === 'staff') {
                root.innerHTML = renderStaff();
            } else if (state.userRole === 'public') {
                root.innerHTML = renderPublic();
            }
        }

        function handleDispatch(e) {
            e.preventDefault();
            const r = parseInt(document.getElementById('rAmt').value) || 0;
            const s = parseInt(document.getElementById('sAmt').value) || 0;
            const v = document.getElementById('vSelect').value;
            if (r <= 0 && s <= 0) return Swal.fire('Error', 'Enter a valid amount', 'warning');
            state.stock.rice += r; state.stock.sugar += s;
            state.notifications.unshift({ id: Date.now(), text: `Stock injected successfully to ${v}.`, time: new Date().toLocaleTimeString(), read: false });
            addAudit(`Dispatched ${r}kg Rice and ${s}kg Sugar to ${v}`);
            Swal.fire('Success', 'Inventory authorized and routed.', 'success');
            render();
        }

        function handleReq(id, status) {
            state.deliveryRequests = state.deliveryRequests.map(r => r.id === id ? {...r, status} : r);
            addAudit(`Delivery request #${id} ${status}`);
            render();
        }

        function initBilling(e) {
            e.preventDefault();
            const card = document.getElementById('cInput').value;
            if (!card) return;
            if (state.usersWhoBought.includes(card)) {
                document.body.insertAdjacentHTML('beforeend', '<div class="fraud-overlay"></div>');
                Swal.fire({ title: 'FRAUD ALERT', text: 'Card purchase already logged this month.', icon: 'error', background: '#450a0a', color: '#fff' }).then(() => {
                    document.querySelector('.fraud-overlay')?.remove();
                });
                return;
            }
            state.activeBill = { cardNumber: card, items: [], total: 0, paid: false };
            render();
        }

        function addBillItem() {
            const id = document.getElementById('commSelect').value;
            const qty = parseInt(document.getElementById('commQty').value) || 1;
            const comm = COMMODITIES.find(c => c.id === id);
            state.activeBill.items.push({ id: Math.random().toString(36).substr(2, 9), ...comm, quantity: qty, pricePerUnit: comm.price });
            render();
        }

        function removeBillItem(id) {
            state.activeBill.items = state.activeBill.items.filter(i => i.id !== id);
            render();
        }

        function commitBill() {
            if (state.activeBill.items.length === 0) return Swal.fire('Error', 'No items in bill', 'warning');
            Swal.fire('Transaction Published', 'Citizen can now pay via the portal.', 'success');
            // We keep it active so the public user can "see" it
            render();
        }

        function bookToken() {
            state.bookedToken = state.tokens + 9;
            Swal.fire('Slot Confirmed', `Priority Token #${state.bookedToken} issued. Arrive at 11:45 AM.`, 'success');
            render();
        }

        function handlePay() {
            Swal.fire({
                title: 'Payment Gateway',
                html: `<div class="p-6 bg-white rounded-3xl inline-block shadow-2xl border-2 border-primary/20"><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=SMARTPDS-PAY-${Date.now()}"></div>`,
                confirmButtonText: 'I Have Paid',
                showCancelButton: true
            }).then(res => {
                if (res.isConfirmed) {
                    state.activeBill.paid = true;
                    state.usersWhoBought.push(state.activeBill.cardNumber);
                    Swal.fire('Success', 'Payment verified. Show receipt at counter.', 'success');
                    render();
                }
            });
        }

        function quickAction(label) {
            Swal.fire('Info', `${label} module is being optimized for your tier.`, 'info');
        }

        function initChart() {
            const canvas = document.getElementById('adminStockChart');
            if (!canvas) return;
            new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Zone A', 'Zone B', 'Zone C', 'Zone D', 'Zone E'],
                    datasets: [{
                        label: 'Rice', data: [state.stock.rice, 850, 1100, 950, 1200], borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.1)', fill: true, tension: 0.4
                    }, {
                        label: 'Sugar', data: [state.stock.sugar, 300, 450, 400, 500], borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: state.isDarkMode ? '#f8fafc' : '#0f172a' } } },
                    scales: {
                        y: { grid: { color: state.isDarkMode ? 'rgba(255, 255, 255, 0.05)' : 'rgba(0,0,0,0.05)' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        // Start
        render();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
